<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CDR</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard CDR</h1>
            <p class="subtitle">An√°lisis de Llamadas en Tiempo Real</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-container">
                <h2 style="color: #667eea; margin-bottom: 10px;">Conectar al Sistema CUAD Telmex</h2>
                <p style="color: #666; margin-bottom: 25px;">Ingresa tus credenciales para consultar los CDR</p>
                
                <!-- Paso 1: Credenciales -->
                <div id="step1" class="step-container">
                    <form id="credentialsForm">
                        <div class="form-group">
                            <label>üë§ Usuario CUAD</label>
                            <input type="text" id="userid" placeholder="usuario.nombre" required>
                        </div>
                        <div class="form-group">
                            <label>üîí Contrase√±a</label>
                            <input type="password" id="userpass" placeholder="contrase√±a" required>
                        </div>
                        <button type="submit" class="btn-primary" id="loginBtn">
                            <span id="loginBtnText">üöÄ Conectar y Cargar Datos</span>
                            <span id="loginBtnLoader" class="hidden">‚è≥ Conectando...</span>
                        </button>
                        <p style="color: #888; font-size: 0.9em; margin-top: 15px;">
                            Se cargar√°n autom√°ticamente los CDR desde el d√≠a 1 del mes actual hasta hoy
                        </p>
                    </form>
                </div>

                <!-- Paso 2: Opciones de consulta (oculto inicialmente) -->
                <div id="step2" class="step-container hidden">
                    <div class="session-info">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>‚úì Sesi√≥n activa:</strong> <span id="sessionUser"></span>
                            </div>
                            <button class="btn-secondary" id="logoutBtn">Cerrar Sesi√≥n</button>
                        </div>
                    </div>

                    <h3 style="color: #333; margin: 25px 0 15px 0;">üîç Nueva Consulta Personalizada</h3>
                    
                    <form id="customQueryForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>üìÖ Fecha/Hora Inicio</label>
                                <input type="datetime-local" id="customFromDate" required>
                            </div>
                            <div class="form-group">
                                <label>üìÖ Fecha/Hora Fin</label>
                                <input type="datetime-local" id="customToDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üìû Origen (opcional)</label>
                                <input type="text" id="customSource" placeholder="N√∫mero origen">
                            </div>
                            <div class="form-group">
                                <label>üì± Destino (opcional)</label>
                                <input type="text" id="customDestination" placeholder="Extensi√≥n destino">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" id="queryBtn">
                            <span id="queryBtnText">üîÑ Actualizar Consulta</span>
                            <span id="queryBtnLoader" class="hidden">‚è≥ Consultando...</span>
                        </button>
                    </form>
                </div>

                <!-- Opci√≥n alternativa: Cargar JSON -->
                <div class="divider">
                    <span>O</span>
                </div>

                <div class="upload-alternative">
                    <h3 style="color: #333; margin-bottom: 15px;">üìÅ Cargar archivo JSON</h3>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Arrastra tu archivo JSON aqu√≠</div>
                        <div class="upload-hint">o haz clic para seleccionar</div>
                        <input type="file" id="fileInput" accept=".json">
                    </div>
                    <div class="file-info hidden" id="fileInfo"></div>
                </div>

                <div class="alert hidden" id="alertMsg"></div>
            </div>
        </div>

        <div id="dashboardContent" class="hidden">
            <!-- Barra de control superior -->
            <div class="dashboard-controls">
                <div class="controls-left">
                    <div class="user-info">
                        <span class="user-badge">üë§ <strong id="dashboardUser"></strong></span>
                        <span class="records-count" id="recordsCount">0 registros</span>
                    </div>
                </div>
                <div class="controls-right">
                    <button class="btn-icon" id="btnNewQuery" title="Nueva consulta">
                        üîç Nueva Consulta
                    </button>
                    <button class="btn-icon btn-danger" id="btnLogout" title="Cerrar sesi√≥n">
                        üö™ Cerrar Sesi√≥n
                    </button>
                </div>
            </div>

            <!-- Panel de consulta r√°pida (oculto por defecto) -->
            <div class="quick-query-panel hidden" id="quickQueryPanel">
                <div class="panel-header">
                    <h3>üîç Nueva Consulta de CDR</h3>
                    <button class="btn-close" id="btnCloseQuery">√ó</button>
                </div>
                <form id="quickQueryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>üìÖ Desde</label>
                            <input type="datetime-local" id="quickFromDate" required>
                        </div>
                        <div class="form-group">
                            <label>üìÖ Hasta</label>
                            <input type="datetime-local" id="quickToDate" required>
                        </div>
                    </div>
                    
                    <!-- Atajos de fecha -->
                    <div class="date-shortcuts">
                        <button type="button" class="btn-shortcut" data-range="today">Hoy</button>
                        <button type="button" class="btn-shortcut" data-range="yesterday">Ayer</button>
                        <button type="button" class="btn-shortcut" data-range="week">Esta Semana</button>
                        <button type="button" class="btn-shortcut" data-range="month">Este Mes</button>
                        <button type="button" class="btn-shortcut" data-range="last7">√öltimos 7 d√≠as</button>
                        <button type="button" class="btn-shortcut" data-range="last30">√öltimos 30 d√≠as</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>üìû Origen (opcional)</label>
                            <input type="text" id="quickSource" placeholder="N√∫mero origen">
                        </div>
                        <div class="form-group">
                            <label>üì± Destino (opcional)</label>
                            <input type="text" id="quickDestination" placeholder="Extensi√≥n destino">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary" id="quickQueryBtn">
                        <span id="quickQueryBtnText">üîÑ Consultar</span>
                        <span id="quickQueryBtnLoader" class="hidden">‚è≥ Consultando...</span>
                    </button>
                </form>
                <div class="alert hidden" id="quickAlertMsg"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Llamadas</div>
                    <div class="stat-value" id="totalCalls">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Llamadas Contestadas</div>
                    <div class="stat-value" id="answeredCalls">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Duraci√≥n Total (min)</div>
                    <div class="stat-value" id="totalDuration">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Promedio Duraci√≥n</div>
                    <div class="stat-value" id="avgDuration">0s</div>
                </div>
            </div>

            <div class="filters">
                <h3 style="color: #333; margin-bottom: 15px;">üîç Filtros</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <label>Estado</label>
                        <select id="filterDisposition">
                            <option value="">Todos</option>
                            <option value="ANSWERED">Contestadas</option>
                            <option value="NO ANSWER">No Contestadas</option>
                            <option value="FAILED">Fallidas</option>
                            <option value="BUSY">Ocupado</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Extensi√≥n Destino</label>
                        <div class="multiselect-wrapper">
                            <div class="multiselect-display" id="multiselectDisplay">
                                <span class="multiselect-placeholder">Seleccionar extensiones...</span>
                            </div>
                            <div class="multiselect-dropdown hidden" id="multiselectDropdown">
                                <div class="multiselect-search">
                                    <input type="text" id="extensionSearch" placeholder="Buscar extensi√≥n...">
                                </div>
                                <div class="multiselect-options" id="multiselectOptions">
                                    <!-- Las opciones se generar√°n din√°micamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-item">
                        <label>N√∫mero Origen</label>
                        <input type="text" id="filterSrc" placeholder="Buscar n√∫mero...">
                    </div>
                    <div class="filter-item">
                        <label>Duraci√≥n M√≠nima (seg)</label>
                        <input type="number" id="filterDuration" placeholder="0">
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Distribuci√≥n por Estado</div>
                    <canvas id="dispositionChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Llamadas por Extensi√≥n</div>
                    <canvas id="extensionChart"></canvas>
                </div>
            </div>

            <div class="chart-card chart-full-width">
                <div class="chart-title">Llamadas por Hora del D√≠a</div>
                <canvas id="hourChart"></canvas>
            </div>

            <!-- Nuevas Anal√≠ticas Avanzadas -->
            <div class="analytics-section">
                <h2 class="section-title">üìä Anal√≠ticas Avanzadas</h2>
                
                <div class="charts-grid">
                    <!-- Tasa de √âxito -->
                    <div class="chart-card">
                        <div class="chart-title">üìà Tasa de √âxito de Llamadas</div>
                        <div class="metric-container">
                            <div class="metric-large">
                                <span class="metric-value" id="successRate">0%</span>
                                <span class="metric-label">Tasa de √âxito</span>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-small success">
                                    <span class="metric-value" id="answeredRate">0%</span>
                                    <span class="metric-label">Contestadas</span>
                                </div>
                                <div class="metric-small warning">
                                    <span class="metric-value" id="noAnswerRate">0%</span>
                                    <span class="metric-label">No Contestadas</span>
                                </div>
                                <div class="metric-small danger">
                                    <span class="metric-value" id="failedRate">0%</span>
                                    <span class="metric-label">Fallidas</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top N√∫meros Origen -->
                    <div class="chart-card">
                        <div class="chart-title">üìû Top 10 N√∫meros Origen</div>
                        <canvas id="topSourceChart"></canvas>
                    </div>
                </div>

                <div class="charts-grid">
                    <!-- Duraci√≥n Promedio por Hora -->
                    <div class="chart-card">
                        <div class="chart-title">‚è±Ô∏è Duraci√≥n Promedio por Hora</div>
                        <canvas id="avgDurationChart"></canvas>
                    </div>

                    <!-- Llamadas por D√≠a de Semana -->
                    <div class="chart-card">
                        <div class="chart-title">üìÖ Llamadas por D√≠a de la Semana</div>
                        <canvas id="weekdayChart"></canvas>
                    </div>
                </div>

                <div class="chart-card chart-full-width">
                    <div class="chart-title">üïí Mapa de Calor - Llamadas por D√≠a y Hora</div>
                    <div id="heatmapContainer"></div>
                </div>

                <!-- Tabla de Top Destinos -->
                <div class="chart-card chart-full-width">
                    <div class="chart-title">üéØ An√°lisis por Extensi√≥n Destino</div>
                    <div class="top-destinations-table">
                        <table id="topDestinationsTable">
                            <thead>
                                <tr>
                                    <th>Extensi√≥n</th>
                                    <th>Total Llamadas</th>
                                    <th>Contestadas</th>
                                    <th>No Contestadas</th>
                                    <th>Fallidas</th>
                                    <th>Duraci√≥n Total</th>
                                    <th>Duraci√≥n Promedio</th>
                                    <th>Tasa de √âxito</th>
                                </tr>
                            </thead>
                            <tbody id="topDestinationsBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- KPIs Adicionales -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon">‚è±Ô∏è</div>
                        <div class="kpi-value" id="avgCallDuration">0s</div>
                        <div class="kpi-label">Duraci√≥n Promedio</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">üïê</div>
                        <div class="kpi-value" id="peakHour">-</div>
                        <div class="kpi-label">Hora Pico</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">üìä</div>
                        <div class="kpi-value" id="busyExtension">-</div>
                        <div class="kpi-label">Ext. M√°s Ocupada</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">‚ö°</div>
                        <div class="kpi-value" id="avgWaitTime">0s</div>
                        <div class="kpi-label">Tiempo Espera Prom.</div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <h3 style="color: #333; margin-bottom: 20px;">üìã Detalle de Llamadas</h3>
                <table id="callsTable">
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Estado</th>
                            <th>Duraci√≥n</th>
                            <th>Facturado</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>